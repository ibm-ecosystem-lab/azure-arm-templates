{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "namePrefix": {
            "type": "string",
            "minLength": 3,
            "maxLength": 10,
            "metadata": {
                "description": "Prefix for resource names"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Location for deployment container"
            }
        },
        "rgRoleGuid": {
            "type": "string",
            "defaultValue": "[newGuid()]",
            "metadata": {
                "description": "forceUpdateTag property, used to force the execution of the script resource when no other properties have changed."
            }
        },
        "existingStorageAccount": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Flag to determine whether the storage account already exists"
            }
        },
        "deployOnVnet": {
            "type": "bool",
            "defaultValue": true,
            "metadata": {
                "description": "Flag to determine whether to deploy with a private VNet connection."
            }
        },
        "existingVnet": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Flag to determine whether to create a new virtual network (false) or use existing (true)"
            }
        },
        "vnetCidr": {
            "type": "string",
            "defaultValue": "10.0.0.0/20",
            "metadata": {
                "description": "The address prefix for the new VNet if being created."
            }
        },
        "vnetName": {
            "type": "string",
            "defaultValue": "vnet",
            "metadata": {
                "description": "The name of the new or existing VNet"
            }
        },
        "networkResourceGroup": {
            "type": "string",
            "defaultValue": "[resourceGroup().name]",
            "metadata": {
                "description": "The resource group containing the virtual network"
            }
        },
        "scriptSubnetName": {
            "type": "string",
            "defaultValue": "script-subnet",
            "metadata": {
                "description": "Name of the subnet the script will attach to"
            }
        },
        "scriptSubnetCidr": {
            "type": "string",
            "defaultValue": "10.0.1.0/28",
            "metadata": {
                "description": "Address prefix for the script subnet"
            }
        },
        "endpointSubnetName": {
            "type": "string",
            "defaultValue": "endpoint-subnet",
            "metadata": {
                "description": "Name of the subnet the storage endpoint will attach to"
            }
        },
        "endpointSubnetCidr": {
            "type": "string",
            "defaultValue": "10.0.1.32/28",
            "metadata": {
                "description": "Address prefix for the storage endpoint subnet"
            }
        },
        "storageAccountName": {
            "type": "string",
            "defaultValue": "[concat(parameters('namePrefix'), 'deployscript',substring(uniqueString(resourceGroup().id),1,7))]",
            "metadata": {
                "description": "Name for the storage account for the script execution"
            }            
        },
        "storageResourceGroup": {
            "type": "string",
            "defaultValue": "[resourceGroup().name]",
            "metadata": {
                "description": "The resource group containing the storage account"
            }
        },
        "createManagedIdentity": {
            "type": "bool",
            "defaultValue": true,
            "metadata": {
                "description": "Flag to determine whether to create a new managed identity for script execution"
            }
        },
        "managedIdName": {
            "type": "string",
            "defaultValue": "[concat(parameters('namePrefix'),'-script-id')]",
            "metadata": {
                "description": "Name of the managed identity used for deployment scripts"
            }
        }       
    },
    "variables": {
      "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
      "roleDefinitionName": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdName')), variables('roleDefinitionId'), resourceGroup().id)]"
    },
    "resources": [
        {  
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2023-06-01",
            "name": "[parameters('vnetName')]",
            "condition": "[and(not(parameters('existingVnet')),parameters('deployOnVnet'))]",
            "location": "[parameters('location')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "[parameters('vnetCIDR')]"
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2023-07-01",
            "name": "configureSubnets",
            "resourceGroup": "[parameters('networkResourceGroup')]",
            "condition": "[parameters('deployOnVnet')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "Inner"
                },
                "parameters": {
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    },
                    "scriptSubnetName": {
                        "value": "[parameters('scriptSubnetName')]"
                    },
                    "scriptSubnetCidr": {
                        "value": "[parameters('scriptSubnetCidr')]"
                    },
                    "endpointSubnetName": {
                        "value": "[parameters('endpointSubnetName')]"
                    },
                    "endpointSubnetCidr": {
                        "value": "[parameters('endpointSubnetCidr')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "vnetName": {
                            "type": "string"
                        },
                        "scriptSubnetName": {
                            "type": "string"
                        },
                        "scriptSubnetCidr": {
                            "type": "string"
                        },
                        "endpointSubnetName": {
                            "type": "string"
                        },
                        "endpointSubnetCidr": {
                            "type": "string"
                        }
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Network/virtualNetworks/subnets",
                            "apiVersion": "2023-06-01",
                            "name": "[format('{0}/{1}', parameters('vnetName'), parameters('scriptSubnetName'))]",
                            "properties": {
                                "addressPrefix": "[parameters('scriptSubnetCidr')]",
                                "serviceEndpoints": [
                                    {
                                        "service": "Microsoft.Storage"
                                    }
                                ],
                                "delegations": [
                                    {
                                        "name": "Microsoft.ContainerInstance.containerGroups",
                                        "properties": {
                                            "serviceName": "Microsoft.ContainerInstance/containerGroups"
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.Network/virtualNetworks/subnets",
                            "apiVersion": "2023-06-01",
                            "name": "[format('{0}/{1}', parameters('vnetName'), parameters('endpointSubnetName'))]",
                            "properties": {
                                "addressPrefix": "[parameters('endpointSubnetCidr')]",
                                "serviceEndpoints": [
                                    {
                                        "service": "Microsoft.Storage"
                                    }
                                ]
                            }
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2024-07-01",
            "name": "deploymentScript",
            "comments": "Creates storage account and private endpoints",
            "dependsOn": [
                "[resourceId(parameters('networkResourceGroup'),'Microsoft.Resources/deployments', 'configureSubnets')]",
                "[resourceId('Microsoft.Resources/deployments', 'configureStorage')]",
                "[resourceId('Microsoft.Authorization/roleAssignments', variables('roleDefinitionName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "Inner"
                },
                "parameters": {
                    "namePrefix": {
                        "value": "[parameters('namePrefix')]"
                    },
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    },
                    "networkResourceGroup": {
                        "value": "[parameters('networkResourceGroup')]"
                    },
                    "scriptSubnetName": {
                        "value": "[parameters('scriptSubnetName')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "managedIdName": {
                        "value": "[parameters('managedIdName')]"
                    },
                    "deployOnVnet": {
                        "value": "[parameters('deployOnVnet')]"
                    },
                    "rgRoleGuid": {
                        "value": "[parameters('rgRoleGuid')]"
                    },
                    "storageAccountName": {
                        "value": "[parameters('storageAccountName')]"
                    },
                    "storageResourceGroup": {
                        "value": "[parameters('storageResourceGroup')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "namePrefix": {
                            "type": "string"
                        },
                        "location": {
                            "type": "string"
                        },
                        "scriptSubnetName": {
                            "type": "string"
                        },
                        "networkResourceGroup": {
                            "type": "string"
                        },
                        "vnetName": {
                            "type": "string"
                        },
                        "managedIdName": {
                            "type": "string"
                        },
                        "rgRoleGuid": {
                            "type": "string"
                        },
                        "deployOnVnet": {
                            "type": "bool"
                        },
                        "storageAccountName": {
                            "type": "string"
                        },
                        "storageResourceGroup": {
                            "type": "string"
                        }

                    },
                    "variables": {
                        "containerGroupName": "[concat(parameters('namePrefix'), '-cg')]",
                        "scriptName": "[concat(parameters('namePrefix'),'-script')]",
                        "subnetIds": [
                            {
                                "id": "[resourceId(parameters('networkResourceGroup'),'Microsoft.Network/virtualNetworks/subnets',parameters('vnetName'),parameters('scriptSubnetName'))]",
                                "name": "[parameters('scriptSubnetName')]"
                            }
                        ],
                        "azureCliVersion": "2.60.0"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Resources/deploymentScripts",
                            "apiVersion": "2023-08-01",
                            "comments": "Deploys a test container",
                            "name": "[variables('scriptName')]",
                            "location": "[parameters('location')]",
                            "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                    "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdName'))]": {}
                                }
                            },
                            "kind": "AzureCLI",
                            "properties": {
                                "forceUpdateTag": "[parameters('rgRoleGuid')]",
                                "containerSettings": {
                                    "containerGroupName": "[variables('containerGroupName')]",
                                    "subnetIds": "[if(parameters('deployOnVnet'),variables('subnetIds'),json('null'))]"
                                },
                                "storageAccountSettings": {
                                    "storageAccountName": "[parameters('storageAccountName')]",
                                    "storageAccountKey": "[listKeys(resourceId(parameters('storageResourceGroup'),'Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-04-01').keys[0].value]"
                                },
                                "azCliVersion": "[variables('azureCliVersion')]",  
                                "environmentVariables": [
                                    {
                                        "name": "RESOURCE_GROUP",
                                        "value": "[resourceGroup().name]"
                                    }
                                ],
                                "scriptContent": "while true; do sleep 30; done;",
                                "timeout": "PT120M",
                                "cleanupPreference": "OnSuccess",
                                "retentionInterval": "P1D"
                            },
                            "dependsOn": [
                            ]
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2024-07-01",
            "name": "configureStorage",
            "condition": "[not(parameters('existingStorageAccount'))]",
            "comments": "Creates storage account and private endpoints",
            "dependsOn": [
                "[resourceId(parameters('networkResourceGroup'),'Microsoft.Resources/deployments', 'configureSubnets')]"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "Inner"
                },
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "storageAccountName": {
                        "value": "[parameters('storageAccountName')]"
                    },
                    "endpointSubnetName": {
                        "value": "[parameters('endpointSubnetName')]"
                    },
                    "networkResourceGroup": {
                        "value": "[parameters('networkResourceGroup')]"
                    },
                    "scriptSubnetName": {
                        "value": "[parameters('scriptSubnetName')]"
                    },
                    "storageEndpointName": {
                        "value": "[concat(parameters('namePrefix'),'-storage-endpoint')]"
                    },
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    }

                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "location": {
                            "type": "string"
                        },
                        "storageAccountName":  {
                            "type": "string"
                        },
                        "networkResourceGroup": {
                            "type": "string"
                        },
                        "vnetName": {
                            "type": "string"
                        },
                        "scriptSubnetName": {
                            "type": "string"
                        },
                        "storageEndpointName": {
                            "type": "string"
                        },
                        "endpointSubnetName": {
                            "type": "string"
                        }

                    },
                    "variables": {
                        "storageZoneName": "[concat('privatelink.file.',environment().suffixes.storage)]"
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Storage/storageAccounts",
                            "apiVersion": "2023-04-01",
                            "name": "[parameters('storageAccountName')]",
                            "location": "[parameters('location')]",
                            "sku": {
                                "name": "Standard_LRS"
                            },
                            "kind": "StorageV2",
                            "properties": {
                                "supportsHttpsTrafficOnly": true,
                                "allowSharedKeyAccess": true,
                                "isHnsEnabled": false,
                                "minimumTlsVersion": "TLS1_2",
                                "allowBlobPublicAccess": false,
                                "publicNetworkAccess": "Enabled",
                                "networkAcls": {
                                    "bypass": "AzureServices",
                                    "defaultAction": "Deny",
                                    "virtualNetworkRules": [
                                        {
                                            "id": "[resourceId(parameters('networkResourceGroup'),'Microsoft.Network/virtualNetworks/subnets',parameters('vnetName'),parameters('scriptSubnetName'))]",
                                            "action": "Allow"
                                        }
                                    ]
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Network/privateDnsZones",
                            "apiVersion": "2024-06-01",
                            "name": "[variables('storageZoneName')]",
                            "location": "global",
                            "properties": {}
                        },
                        {
                            "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                            "apiVersion": "2024-06-01",
                            "name": "[concat(variables('storageZoneName'),'/',parameters('vnetName'),'-link')]",
                            "location": "global",
                            "properties": {
                                "registrationEnabled": false,
                                "virtualNetwork": {
                                    "id": "[resourceId(parameters('networkResourceGroup'),'Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                                }
                            },
                            "dependsOn": [
                                "[resourceId('Microsoft.Network/privateDnsZones', variables('storageZoneName'))]"
                            ]
                        },
                        {
                            "type": "Microsoft.Network/privateEndpoints",
                            "apiVersion": "2023-11-01",
                            "name": "[parameters('storageEndpointName')]",
                            "location": "[parameters('location')]",
                            "properties": {
                                "subnet": {
                                    "id": "[resourceId(parameters('networkResourceGroup'),'Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('endpointSubnetName'))]"
                                },
                                "privateLinkServiceConnections": [
                                    {
                                        "name": "[parameters('storageEndpointName')]",
                                        "properties": {
                                            "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts',parameters('storageAccountName'))]",
                                            "groupIds": [
                                                "file"
                                            ]
                                        }
                                    }
                                ]
                            },
                            "dependsOn": [
                                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
                            ]
                        },
                        {
                            "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                            "apiVersion": "2022-07-01",
                            "name": "[concat(parameters('storageEndpointName'),'/','dnsgroupname')]",
                            "properties": {
                                "privateDnsZoneConfigs": [
                                    {
                                        "name": "premium",
                                        "properties": {
                                            "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', variables('storageZoneName'))]"
                                        }
                                    }
                                ]
                            },
                            "dependsOn": [
                                "[resourceId('Microsoft.Network/privateEndpoints',parameters('storageEndpointName'))]"
                            ]
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
            "apiVersion": "2023-01-31",
            "name": "[parameters('managedIdName')]",
            "condition": "[parameters('createManagedIdentity')]",
            "location": "[parameters('location')]"
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2022-04-01",
            "name": "[variables('roleDefinitionName')]",
            "condition": "[parameters('createManagedIdentity')]",
            "dependsOn": [
                "[parameters('managedIdName')]"
            ],
            "properties": {
                "roleDefinitionId": "[variables('roleDefinitionId')]",
                "principalId": "[reference(parameters('managedIdName'), '2023-01-31').principalId]",
                "scope": "[resourceGroup().id]",
                "principalType": "ServicePrincipal"
            }
        }
    ]
}